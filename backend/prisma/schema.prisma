generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name       String
  plan       String    @default("starter")
  configJson Json      @default("{}") @map("config_json")
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime  @default(now()) @map("updated_at") @db.Timestamptz(6)
  users      User[]
  employees  Employee[]

  @@map("companies")
}

model User {
  id         String          @id @db.Uuid
  companyId  String          @map("company_id") @db.Uuid
  role       String
  email      String?
  createdAt  DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime        @default(now()) @map("updated_at") @db.Timestamptz(6)
  company    Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  layout     DashboardLayout?

  @@map("users")
}

model Employee {
  id               String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId        String            @map("company_id") @db.Uuid
  managerId        String?           @map("manager_id") @db.Uuid
  salary           String?
  role             String?
  tenureMonths     Int               @default(0) @map("tenure_months")
  missedCheckins   Int               @default(0) @map("missed_checkins")
  notes            String?
  createdAt        DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime          @default(now()) @map("updated_at") @db.Timestamptz(6)
  company          Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  manager          Employee?         @relation("EmployeeManager", fields: [managerId], references: [id], onDelete: SetNull)
  directReports    Employee[]        @relation("EmployeeManager")
  scores           Score[]
  riskFlags        FlightRiskFlag[]
  peerFeedbackFrom PeerFeedback[]    @relation("PeerFeedbackFrom")
  peerFeedbackTo   PeerFeedback[]    @relation("PeerFeedbackTo")
  auditLogs        AuditLog[]

  @@index([companyId])
  @@index([managerId])
  @@map("employees")
}

model Score {
  id              BigInt    @id @default(autoincrement())
  employeeId      String    @map("employee_id") @db.Uuid
  componentValues Json      @default("{}") @map("component_values")
  finalScore      Decimal   @map("final_score") @db.Decimal(6, 2)
  formulaVersion  Int?      @map("formula_version")
  month           String
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  employee        Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, month])
  @@index([employeeId])
  @@index([month])
  @@map("scores")
}

model PeerFeedback {
  id           BigInt    @id @default(autoincrement())
  fromEmployee String    @map("from_employee") @db.Uuid
  toEmployee   String    @map("to_employee") @db.Uuid
  score        Decimal   @db.Decimal(6, 2)
  timestamp    DateTime  @default(now()) @db.Timestamptz(6)
  from         Employee  @relation("PeerFeedbackFrom", fields: [fromEmployee], references: [id], onDelete: Cascade)
  to           Employee  @relation("PeerFeedbackTo", fields: [toEmployee], references: [id], onDelete: Cascade)

  @@map("peer_feedback")
}

model FlightRiskFlag {
  id             BigInt    @id @default(autoincrement())
  employeeId     String    @map("employee_id") @db.Uuid
  reason         String
  triggeredBy    String    @map("triggered_by")
  resolvedStatus Boolean   @default(false) @map("resolved_status")
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  employee       Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([resolvedStatus])
  @@map("flight_risk_flags")
}

model AuditLog {
  id           BigInt    @id @default(autoincrement())
  tableName    String    @map("table_name")
  changedBy    String    @map("changed_by")
  employeeId   String?   @map("employee_id") @db.Uuid
  oldValue     Json?     @map("old_value")
  newValue     Json?     @map("new_value")
  reason       String?
  timestamp    DateTime  @default(now()) @db.Timestamptz(6)
  previousHash String?   @map("previous_hash")
  hash         String
  employee     Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)

  @@index([employeeId])
  @@index([timestamp])
  @@map("audit_logs")
}

model DashboardLayout {
  userId           String   @id @map("user_id") @db.Uuid
  widgetConfigJson Json     @default("{}") @map("widget_config_json")
  updatedAt        DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("dashboard_layout")
}